<!DOCTYPE html>
<html data-bs-theme="dark" lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Admin Bento Grid - Tragalero</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./assets/css/pastel-theme.css">

    <style>
        :root {
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            margin: 0;
            padding: 0;
        }

        .admin-layout {
            display: flex;
            height: 100vh;
        }

        .controls-panel {
            width: 350px;
            background: var(--bs-body-bg);
            padding: 30px;
            border-right: 1px solid rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 10;
        }

        [data-bs-theme="dark"] .controls-panel {
            border-right-color: rgba(255,255,255,0.1);
        }

        .preview-panel {
            flex-grow: 1;
            padding: 50px;
            overflow-y: auto;
            background: rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        [data-bs-theme="dark"] .preview-panel {
            background: #111;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: 140px;
            gap: 15px;
            width: 100%;
            max-width: 800px;
            background: rgba(0,0,0,0.05);
            padding: 20px;
            border-radius: 30px;
            min-height: 200px;
        }

        [data-bs-theme="dark"] .bento-grid {
            background: #222;
        }

        .bento-item {
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #444;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: all var(--transition-speed) ease;
            position: relative;
            cursor: pointer;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
        }

        .bento-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }

        .bento-item.selected {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 4px rgba(var(--bs-primary-rgb), 0.2);
        }

        .slot-controls {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        [data-bs-theme="dark"] .slot-controls {
            border-top-color: rgba(255,255,255,0.1);
        }

        .pastel-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            display: inline-block;
            margin: 5px;
        }

        .pastel-btn:hover, .pastel-btn.active {
            border-color: var(--bs-body-color);
            transform: scale(1.2);
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .theme-switcher-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar Controls -->
        <div class="controls-panel">
            <div class="d-flex align-items-center mb-4">
                <img src="https://tragalero.com/assets/img/tragalero.png" alt="Tragalero" height="30" class="me-2">
                <h4 class="fw-bold mb-0">Grid Editor</h4>
            </div>

            <button class="btn btn-custom-primary w-100 mb-4 fw-bold" id="addSlotBtn">
                <i class="bi bi-plus-lg me-2"></i>Agregar Slot
            </button>

            <div id="editForm" class="slot-controls" style="display: none;">
                <h6 class="text-uppercase small fw-bold text-muted mb-3">Propiedades del Slot</h6>

                <div class="mb-3">
                    <label class="form-label small">Etiqueta</label>
                    <input type="text" id="slotLabel" class="form-control" placeholder="Ej: Apps">
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label small">Ancho (Cols)</label>
                        <select id="slotCols" class="form-select">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label small">Alto (Rows)</label>
                        <select id="slotRows" class="form-select">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label small">Color Pastel</label>
                    <div class="color-palette">
                        <div class="pastel-btn" style="background-color: #dcf0fa;" data-color="#dcf0fa"></div>
                        <div class="pastel-btn" style="background-color: #e9dcfb;" data-color="#e9dcfb"></div>
                        <div class="pastel-btn" style="background-color: #fbe0e0;" data-color="#fbe0e0"></div>
                        <div class="pastel-btn" style="background-color: #fef9c3;" data-color="#fef9c3"></div>
                        <div class="pastel-btn" style="background-color: #fde2c4;" data-color="#fde2c4"></div>
                        <div class="pastel-btn" style="background-color: #e2fbd7;" data-color="#e2fbd7"></div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-primary flex-grow-1 fw-bold" id="applyBtn">Aplicar</button>
                    <button class="btn btn-outline-danger" id="deleteBtn"><i class="bi bi-trash"></i></button>
                </div>
            </div>

            <div class="mt-5 pt-3 border-top border-secondary">
                <button class="btn btn-success w-100 fw-bold" id="saveAllBtn">
                    <i class="bi bi-cloud-upload me-2"></i>Guardar Cambios
                </button>
                <div id="saveStatus" class="small text-center mt-2" style="display: none;"></div>
            </div>
        </div>

        <!-- Grid Preview -->
        <div class="preview-panel">
            <div class="theme-switcher-container">
                <div class="theme-switcher-bar d-flex">
                    <button class="theme-btn" data-theme-value="light" title="Modo Amarillo"><i class="bi bi-sun-fill"></i></button>
                    <button class="theme-btn" data-theme-value="dark" title="Modo Oscuro"><i class="bi bi-moon-stars-fill"></i></button>
                    <button class="theme-btn" data-theme-value="medio" title="Modo Suave"><i class="bi bi-palette-fill"></i></button>
                </div>
            </div>

            <h2 class="fw-bold mb-4 animate-fade-in">Vista Previa</h2>
            <div class="bento-grid" id="bentoGrid">
                <!-- Items dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./assets/js/theme.js"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://cnoiesjjupubkrgyhbof.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNub2llc2pqdXB1YmtyZ3loYm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjYxMjIsImV4cCI6MjA4NjIwMjEyMn0.GZ3gGs7Wk4IJm0Ebp-3bAUlFtKHPV6jTpLATacLcJhA';

        // Use a different variable name to avoid shadowing global 'supabase' from CDN
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let gridData = [];
        let selectedId = null;

        const gridContainer = document.getElementById('bentoGrid');
        const editForm = document.getElementById('editForm');
        const slotLabel = document.getElementById('slotLabel');
        const slotCols = document.getElementById('slotCols');
        const slotRows = document.getElementById('slotRows');
        const pastelBtns = document.querySelectorAll('.pastel-btn');
        let selectedColor = '#dcf0fa';

        // Load data
        async function loadGrid() {
            try {
                const { data, error } = await sbClient
                    .from('bento_grid')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (data && data.length > 0) {
                    gridData = data;
                } else {
                    console.log("No data or error from Supabase, using fallback.");
                    setFallbackData();
                }
            } catch (e) {
                console.error("Supabase load failed, using fallback.", e);
                setFallbackData();
            }
            renderGrid();
        }

        function setFallbackData() {
            gridData = [
                { id: '1', label: 'Formularios', col_span: 2, row_span: 2, bg_color: '#dcf0fa' },
                { id: '2', label: 'Pos', col_span: 1, row_span: 1, bg_color: '#e9dcfb' },
                { id: '3', label: 'Website', col_span: 1, row_span: 1, bg_color: '#fbe0e0' },
                { id: '4', label: 'Directorio', col_span: 2, row_span: 2, bg_color: '#dcf0fa' },
                { id: '5', label: 'Apps', col_span: 1, row_span: 2, bg_color: '#fde2c4' }
            ];
        }

        function renderGrid() {
            gridContainer.innerHTML = '';
            gridData.forEach(item => {
                const div = document.createElement('div');
                div.className = `bento-item ${selectedId === item.id ? 'selected' : ''}`;
                div.style.gridColumn = `span ${item.col_span}`;
                div.style.gridRow = `span ${item.row_span}`;
                div.style.backgroundColor = item.bg_color;
                div.textContent = item.label;
                div.onclick = (e) => {
                    e.stopPropagation();
                    selectSlot(item.id);
                };
                gridContainer.appendChild(div);
            });
        }

        // Deselect when clicking empty space
        gridContainer.onclick = () => {
            selectedId = null;
            editForm.style.display = 'none';
            renderGrid();
        };

        function selectSlot(id) {
            selectedId = id;
            const item = gridData.find(i => i.id === id);
            slotLabel.value = item.label;
            slotCols.value = item.col_span;
            slotRows.value = item.row_span;
            selectedColor = item.bg_color;

            updateColorPaletteUI();
            editForm.style.display = 'block';
            renderGrid();
        }

        function updateColorPaletteUI() {
            pastelBtns.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-color') === selectedColor);
            });
        }

        pastelBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedColor = btn.getAttribute('data-color');
                updateColorPaletteUI();
            });
        });

        document.getElementById('addSlotBtn').onclick = () => {
            const newId = Date.now().toString();
            const newItem = {
                id: newId,
                label: 'Nuevo Slot',
                col_span: 1,
                row_span: 1,
                bg_color: '#dcf0fa'
            };
            gridData.push(newItem);
            selectSlot(newId);
        };

        document.getElementById('applyBtn').onclick = () => {
            if (!selectedId) return;
            const index = gridData.findIndex(i => i.id === selectedId);
            gridData[index] = {
                ...gridData[index],
                label: slotLabel.value,
                col_span: parseInt(slotCols.value),
                row_span: parseInt(slotRows.value),
                bg_color: selectedColor
            };
            renderGrid();
        };

        document.getElementById('deleteBtn').onclick = () => {
            if (!selectedId) return;
            gridData = gridData.filter(i => i.id !== selectedId);
            selectedId = null;
            editForm.style.display = 'none';
            renderGrid();
        };

        document.getElementById('saveAllBtn').onclick = async () => {
            const status = document.getElementById('saveStatus');
            status.textContent = 'Guardando...';
            status.style.display = 'block';
            status.className = 'small text-center mt-2 text-info';

            try {
                // Clear existing and insert new for a clean sync
                const { error: deleteError } = await sbClient
                    .from('bento_grid')
                    .delete()
                    .not('id', 'is', null);

                if (deleteError) throw deleteError;

                const toSave = gridData.map(i => ({
                    label: i.label,
                    col_span: i.col_span,
                    row_span: i.row_span,
                    bg_color: i.bg_color
                }));

                const { error: insertError } = await sbClient
                    .from('bento_grid')
                    .insert(toSave);

                if (insertError) throw insertError;

                status.textContent = '¡Guardado con éxito!';
                status.className = 'small text-center mt-2 text-success';
                setTimeout(() => status.style.display = 'none', 3000);
            } catch (err) {
                console.error(err);
                status.textContent = 'Error al guardar. Verifica la tabla en Supabase.';
                status.className = 'small text-center mt-2 text-danger';
            }
        };

        loadGrid();
    </script>
</body>

</html>
